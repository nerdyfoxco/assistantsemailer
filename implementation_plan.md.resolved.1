# Fyxer SaaS Implementation Plan (Canonical Repository Tree)

> [!IMPORTANT]
> **GOVERNANCE ENFORCEMENT**: This project follows a strict "Governance First" approach. The Canonical Repository Tree below is THE LAW. No agent may create files outside this structure. Every file must have a defined context and purpose.

## Goal Description
Build "Fyxer", a governed, evidence-first, fail-closed, AI-native SaaS Operating System. This plan defines the **exact file structure** required to execute the vision, ensuring no drift and total auditability.

## User Review Required
> [!WARNING]
> **Strict Adherence**: The file paths listed below are mandatory. The Agent must not invent new folder roots.
> **Context Enforcement**: Every file created must strictly adhere to the "Context" defined in this tree.

## The Canonical Repository Tree (E2E)

### ğŸ“‚ Root Structure
*Context: The immutable top-level skeleton.*
```text
.
â”œâ”€â”€ foundation/           # [SHARED] The ONLY allowed shared dependency surface.
â”œâ”€â”€ chapters/             # [MODULES] Self-contained, deployable units (12 Chapters).
â”œâ”€â”€ spine/                # [IMPORTS] Python package roots to prevent import chaos.
â”œâ”€â”€ apps/                 # [FRONTEND] Web application roots.
â”œâ”€â”€ ops/                  # [OPS] CI/CD, Scripts, Migrations.
â”œâ”€â”€ .github/              # [CI] GitHub Workflows.
â””â”€â”€ README.md             # [DOCS] System Entry Point.
```

---

### ğŸ§± 1. Foundation: The Shared Surface
*Context: Primitives used by all Chapters. No business logic allowed.*

#### `foundation/contracts/` (Schemas & Laws)
*   **`core_objects.schema.json`**: Defines `Chapter`, `Topic`, `Phase`, `UMP` objects. *Context: Ensures all agents build compatible modules.*
*   **`pipe.schema.json`**: Defines the `Pipe` primitive (id, direction, payload). *Context: Governs data flow between modules.*
*   **`runtime_context.schema.json`**: Defines the Request Context object (tenant_id, actor, trace_id). *Context: Ensures every request is attributable.*
*   **`error.schema.json`**: Defines the Canonical Error object (code, severity, retryable). *Context: Ensures fail-closed error handling.*

#### `foundation/runtime/` (Execution Primitives)
*   **`config.py`**: Environment-aware configuration loader. *Context: Fails hard if `APP_ENV` or secrets are missing.*
*   **`context.py`**: Runtime context manager (`get_context()`). *Context: Enforces Tenant binding at the function level.*
*   **`logging.py`**: Structured JSON logger. *Context: Emits logs strictly matching the audit schema.*
*   **`errors.py`**: Exception classes mapping to `error.schema.json`. *Context: Prevents generic "Exception" usage.*

#### `foundation/guards/` (Enforcement)
*   **`module_guard.py`**: CI script to check import paths. *Context: Ensures Chapters do not import each other directly.*
*   **`seal_guard.py`**: Verifies file hashes against `SEAL.md`. *Context: Detects immutable file tampering.*

#### `foundation/docs/` (System Memory)
*   **`INVENTORY_LIST.md`**: Registry of all created files. *Context: Prevents duplication.*
*   **`WORKLOG.md`**: Append-only log of sealed UMPs. *Context: High-level history.*
*   **`PROOF_INDEX.md`**: Registry of all UMP proofs. *Context: Audit trail root.*

---

### ğŸ“¦ 2. Chapters: The Deployable Modules
*Context: Every Chapter follows the EXACT same internal structure.*

#### **Template Structure (Applied to ALL Chapters)**
```text
chapters/CHxx_NAME/
â”œâ”€â”€ README.md                          # Chapter manifesto.
â””â”€â”€ topics/
    â””â”€â”€ Txx_NAME/
        â”œâ”€â”€ README.md                  # Topic blueprint.
        â””â”€â”€ phases/
            â””â”€â”€ PHxx_NAME/
                â””â”€â”€ umps/
                    â””â”€â”€ CHxx-Txx-PHxx-UMPxxx/  [The Atomic Brick]
                        â”œâ”€â”€ SPEC.md            # What we are building.
                        â”œâ”€â”€ CONTEXT.md         # Why this exists.
                        â”œâ”€â”€ FILES.md           # Exact files list.
                        â”œâ”€â”€ CODE/              # (Files moved to root upon Seal)
                        â”œâ”€â”€ PROOF.md           # Evidence of success.
                        â”œâ”€â”€ SEAL.md            # Immutable Hash.
                        â””â”€â”€ ump_manifest.json  # Machine-readable metadata.
```

---

#### ğŸ”° **CH00: Governance Kernel**
*Context: The Rules of Physics. No runtime logic.*
*   **Topic T01: Definitions**
    *   **Files**: (Moves to `foundation/contracts/` upon seal)
*   **Topic T02: Sealing**
    *   **Files**: (Moves to `foundation/tooling/` upon seal)
*   **Topic T03: Inventory**
    *   **Files**: (Moves to `foundation/docs/` upon seal)

#### ğŸ¦´ **CH01: Foundation Spine**
*Context: Runtime implementation of the Shared Surface.*
*   **Topic T01: Runtime**
    *   `loaders/config_loader.py`: Implements strict env loading.
    *   `context/request_context.py`: Implements tenant binding.
*   **Topic T02: Observability**
    *   `logger/structured_logger.py`: Implements JSON logging.

#### ğŸ¢ **CH02: Tenancy, Auth & Billing**
*Context: Who is allowed to exist.*
*   **Topic T01: Tenancy**
    *   `models/tenant.py`: Tenant logic (Active/Suspended).
    *   `enforcement/lifecycle.py`: Logic to block suspended tenants.
*   **Topic T02: Billing**
    *   `gates/feature_gate.py`: Checks entitlements.

#### ğŸ‘® **CH03: Authority & HITL**
*Context: Who is allowed to act.*
*   **Topic T01: Authority**
    *   `models/authority_level.py`: Defines Levels 0-4.
    *   `enforcement/nhun_guard.py`: "No Human Until Needed" logic.
*   **Topic T02: Delegation**
    *   `models/delegation.py`: User -> HITL delegation rules.

#### âš™ï¸ **CH04: Work Engine**
*Context: The State Machine for Work.*
*   **Topic T01: Work Item**
    *   `models/work_item.py`: The Canonical Work Object.
    *   `statemachine/transitions.py`: Enforces (NOW -> DONE).
*   **Topic T02: Scheduler**
    *   `logic/follow_up.py`: Determines verification logic.

#### ğŸ‘ï¸ **CH05: Connectors (Eyes)**
*Context: Read-only perception.*
*   **Topic T01: Ingestion**
    *   `gmail/fetcher.py`: Ephemeral Gmail API fetcher.
    *   `outlook/fetcher.py`: Ephemeral Outlook API fetcher.
*   **Topic T02: External Data**
    *   `crm/reader.py`: Read-only CRM access.

#### âœ‹ **CH06: Executors (Hands)**
*Context: Controlled Action.*
*   **Topic T01: Communication**
    *   `email/sender.py`: SMTP/API sender (strictly gated).
*   **Topic T02: Automation**
    *   `browser/playwright_driver.py`: Headless browser controller.
    *   `files/ocr_processor.py`: PDF/Image extraction.

#### ğŸ“œ **CH07: Evidence Ledger**
*Context: The Immutable Truth.*
*   **Topic T01: Storage**
    *   `ledger/writer.py`: Appends to immutable log.
    *   `evidence/hasher.py`: Generates cryptographic proofs.

#### ğŸ–¥ï¸ **CH08: Web App Skin**
*Context: The Human Interface.*
*   **Topic T01: Components**
    *   `ui/inbox/Feed.tsx`: The Inbox Feed.
    *   `ui/workbench/TaskView.tsx`: The Work Item view.
    *   `ui/hitl/Console.tsx`: The Operator Console.

#### ğŸ”‘ **CH09: Identity, OAuth & CASA**
*Context: Regulated Access.*
*   **Topic T01: OAuth**
    *   `flows/google_oauth.py`: Google Consent Screen flow.
    *   `tokens/storage.py`: Encrypted token custody.

#### ğŸ›¡ï¸ **CH10: Deployment & Ops**
*Context: Production Safety.*
*   **Topic T01: Secrets**
    *   `secrets/manager.py`: Fail-closed secret loading.
*   **Topic T02: CI/CD**
    *   `pipelines/ump_validator.py`: The CI script ensuring UMP compliance.

#### ğŸ©¹ **CH99: Patch Global**
*Context: The "God Mode" override (Audit logged).*
*   **Topic T01: Hotfix**
    *   `patches/`: Folder for emergency overriding scripts.

---

### ğŸ§  3. Spine: The Python Package Root
*Context: Ensures all backend code is importable as `spine.modules.xxx`.*
```text
spine/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ governance/ -> (Symlink/Ref to CH00)
â”‚   â”œâ”€â”€ foundation/ -> (Symlink/Ref to CH01)
â”‚   â”œâ”€â”€ tenancy/    -> (Ref to CH02)
â”‚   â”œâ”€â”€ authority/  -> (Ref to CH03)
â”‚   â”œâ”€â”€ work/       -> (Ref to CH04)
â”‚   â”œâ”€â”€ connectors/ -> (Ref to CH05)
â”‚   â”œâ”€â”€ executors/  -> (Ref to CH06)
â”‚   â”œâ”€â”€ evidence/   -> (Ref to CH07)
â”‚   â”œâ”€â”€ identity/   -> (Ref to CH09)
â”‚   â””â”€â”€ ops/        -> (Ref to CH10)
â””â”€â”€ README.md
```

### ğŸ’» 4. Apps: The Frontend Root
*Context: The React/Next.js application.*
```text
apps/
â””â”€â”€ web/
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ modules/
    â”‚   â”‚   â”œâ”€â”€ inbox/
    â”‚   â”‚   â”œâ”€â”€ hitl/
    â”‚   â”‚   â””â”€â”€ admin/
    â”‚   â”œâ”€â”€ app.tsx
    â”‚   â””â”€â”€ main.tsx
    â””â”€â”€ package.json
```

### ğŸ› ï¸ 5. Ops: The Machinery
*Context: Operational scripts and configuration.*
```text
ops/
â”œâ”€â”€ ci/
â”‚   â”œâ”€â”€ verify_structure.sh    # The Structure Guard
â”‚   â””â”€â”€ verify_seal.sh         # The Seal Guard
â”œâ”€â”€ security/
â”‚   â””â”€â”€ owasp_scan.sh          # The Security Guard
â””â”€â”€ scripts/
    â””â”€â”€ bootstrap_chapter.sh   # Helper to create folder structures
```

---

## ğŸš¦ Execution Rules (The Contract)

1.  **Context Check**: Before creating a file, verify its `Context` matches the directory it falls under.
2.  **UMP Atomicity**: A UMP must only touch files within its own Chapter (or explicitly allowed `foundation/` files).
3.  **Inventory Lock**: Every file creation must be logged in `INVENTORY_LIST.md`.
4.  **Visual Proof**: Every UMP must conclude with visual evidence in `PROOF.md`.
